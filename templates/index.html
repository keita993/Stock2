<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>株価期待値分析</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .result-table {
            margin-top: 20px;
        }
        .container { margin-top: 30px; }
        .btn { margin: 5px; }
    </style>
</head>
<body>
        <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">株価期待値分析</h1>
            <div>
                <button id="autoPurchaseBtn" class="btn btn-success me-2">
                    <i class="fas fa-robot"></i> 自動購入
                </button>
            </div>
        </div>
        
        <!-- 持ち株リスト -->
        <div id="portfolioSection" class="mb-4" style="display: none;">
            <h2>持ち株リスト</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>銘柄コード</th>
                            <th>銘柄名</th>
                            <th>現在値</th>
                            <th>保有株数</th>
                            <th>購入金額</th>
                            <th>現在の評価額</th>
                            <th>損益率</th>
                            <th>損益額</th>
                            <th>期待値</th>
                            <th>勝率</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioTable">
                    </tbody>
                </table>
            </div>
            <div class="alert alert-info">
                合計投資金額: <span id="totalInvestment">0</span>円<br>
                合計評価額: <span id="totalValue">0</span>円<br>
                合計損益額: <span id="totalProfit">0</span>円<br>
                合計損益率: <span id="totalProfitRate">0</span>%<br>
                平均損益率: <span id="avgProfitRate">0</span>%<br>
                平均損益額: <span id="avgProfitAmount">0</span>円
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label>市場選択:</label>
                    <input type="radio" id="market-prime" name="market" value="prime" checked>
                    <label for="market-prime">プライム</label>
                    <input type="radio" id="market-growth" name="market" value="growth">
                    <label for="market-growth">グロース</label>
                    </div>
                <button type="button" onclick="analyzeStocks()" class="btn btn-primary">分析開始</button>
                <button id="sortByWinRateBtn" class="btn btn-secondary ms-2" disabled>勝率でソート</button>
        </div>
    </div>

        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
                    </div>
            <p class="mt-2">分析中...</p>
            <p id="progressMessage" class="mt-2 text-muted"></p>
            </div>
            
        <div id="results" class="result-table">
            <div class="alert alert-info">
                分析対象銘柄数: <span id="totalStocks">-</span><br>
                期待値+30%以上の銘柄数: <span id="analyzedStocks">-</span><br>
                期待値平均: <span id="avgExpectedValue">-</span>%<br>
                期待値最大値: <span id="maxExpectedValue">-</span>%<br>
                期待値最小値: <span id="minExpectedValue">-</span>%
            </div>

                <div class="table-responsive">
                <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>銘柄コード</th>
                                <th>銘柄名</th>
                            <th>現在値</th>
                            <th>MA20</th>
                            <th>期待値</th>
                            <th>勝率</th>
                            <th>平均利益率</th>
                            <th>最大利益</th>
                            <th>最大損失</th>
                            <th>取引回数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                    <tbody id="resultsTable">
                        </tbody>
                    </table>
                </div>
            </div>

        <!-- チャート表示用モーダル -->
        <div class="modal fade" id="chartModal" tabindex="-1" role="dialog" aria-labelledby="chartModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="chartModalLabel">株価チャート</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        </div>
                    <div class="modal-body">
                        <div id="stockChart" style="height: 400px;"></div>
                    </div>
                        </div>
                    </div>
                </div>
            </div>

    <script>
        let currentResults = [];  // 現在の分析結果を保持

        // ローカルストレージから分析結果を読み込む
        function loadAnalysisResults() {
            const savedResults = localStorage.getItem('analysisResults');
            const savedTimestamp = localStorage.getItem('analysisTimestamp');
            const savedMarket = localStorage.getItem('analysisMarket');
            
            if (savedResults && savedTimestamp && savedMarket) {
                const currentTime = new Date().getTime();
                const savedTime = parseInt(savedTimestamp);
                const hoursSinceLastAnalysis = (currentTime - savedTime) / (1000 * 60 * 60);
                
                // 24時間以内の分析結果の場合
                if (hoursSinceLastAnalysis < 24) {
                    currentResults = JSON.parse(savedResults);
                    displayResults(currentResults);
                    document.getElementById('totalStocks').textContent = currentResults.length;
                    document.getElementById('analyzedStocks').textContent = currentResults.length;
                    
                    // 期待値の統計情報を計算
                    const expectedValues = currentResults.map(result => result.expected_value);
                    const avgExpectedValue = expectedValues.reduce((a, b) => a + b, 0) / expectedValues.length;
                    const maxExpectedValue = Math.max(...expectedValues);
                    const minExpectedValue = Math.min(...expectedValues);
                    
                    // 統計情報を表示
                    document.getElementById('avgExpectedValue').textContent = avgExpectedValue.toFixed(2);
                    document.getElementById('maxExpectedValue').textContent = maxExpectedValue.toFixed(2);
                    document.getElementById('minExpectedValue').textContent = minExpectedValue.toFixed(2);
                    
                    document.getElementById('results').style.display = 'block';
                    document.getElementById('sortByWinRateBtn').disabled = false;
                    
                    // 保存された市場を選択
                    document.querySelector(`input[name="market"][value="${savedMarket}"]`).checked = true;
                    
                    return true;
                }
            }
            return false;
        }

        // 分析結果をローカルストレージに保存
        function saveAnalysisResults(results, market) {
            localStorage.setItem('analysisResults', JSON.stringify(results));
            localStorage.setItem('analysisTimestamp', new Date().getTime().toString());
            localStorage.setItem('analysisMarket', market);
        }

        function analyzeStocks() {
            // 保存された分析結果がある場合は確認
            if (loadAnalysisResults()) {
                if (confirm('24時間以内の分析結果が見つかりました。新しい分析を実行しますか？')) {
                    // 新しい分析を実行
                    performAnalysis();
                }
            } else {
                // 保存された結果がない場合は直接分析を実行
                performAnalysis();
            }
        }

        function performAnalysis() {
            const market = document.querySelector('input[name="market"]:checked').value;
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const sortByWinRateBtn = document.getElementById('sortByWinRateBtn');
            const progressMessage = document.getElementById('progressMessage');
            
            loading.style.display = 'block';
            results.style.display = 'none';
            document.querySelector('button[onclick="analyzeStocks()"]').disabled = true;
            sortByWinRateBtn.disabled = true;
            progressMessage.textContent = '銘柄リストを読み込んでいます...';
            
            fetch('/analyze?market=' + market)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    alert(data.error);
                } else {
                    currentResults = data.results;  // 分析結果を保存
                    saveAnalysisResults(currentResults, market);  // ローカルストレージに保存
                    displayResults(currentResults);

                    document.getElementById('totalStocks').textContent = data.total_stocks;
                    document.getElementById('analyzedStocks').textContent = data.analyzed_stocks;
                    
                    // 期待値の統計情報を計算
                    const expectedValues = data.results.map(result => result.expected_value);
                    const avgExpectedValue = expectedValues.reduce((a, b) => a + b, 0) / expectedValues.length;
                    const maxExpectedValue = Math.max(...expectedValues);
                    const minExpectedValue = Math.min(...expectedValues);
                    
                    // 統計情報を表示
                    document.getElementById('avgExpectedValue').textContent = avgExpectedValue.toFixed(2);
                    document.getElementById('maxExpectedValue').textContent = maxExpectedValue.toFixed(2);
                    document.getElementById('minExpectedValue').textContent = minExpectedValue.toFixed(2);
                    
                    results.style.display = 'block';
                    sortByWinRateBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('分析中にエラーが発生しました。');
            })
            .finally(() => {
                loading.style.display = 'none';
                document.querySelector('button[onclick="analyzeStocks()"]').disabled = false;
            });
        }

        // ページ読み込み時に保存された分析結果を確認
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalysisResults();
            loadPortfolio();
        });

        // 勝率でソートするボタンのイベントリスナー
        document.getElementById('sortByWinRateBtn').addEventListener('click', () => {
            if (currentResults.length > 0) {
                const sortedResults = [...currentResults].sort((a, b) => {
                    const winRateA = a.backtest?.win_rate || 0;
                    const winRateB = b.backtest?.win_rate || 0;
                    return winRateB - winRateA;  // 降順ソート
                });
                displayResults(sortedResults);
            }
        });

        // 結果を表示する関数
        function displayResults(results) {
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = '';
            
            results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.symbol}</td>
                    <td>${result.name}</td>
                    <td>${result.current_price}</td>
                    <td>${result.ma20}</td>
                    <td>${result.expected_value}</td>
                    <td>${result.backtest ? result.backtest.win_rate.toFixed(1) + '%' : '-'}</td>
                    <td>${result.backtest ? result.backtest.avg_profit.toFixed(1) + '%' : '-'}</td>
                    <td>${result.backtest ? result.backtest.max_profit.toFixed(1) + '%' : '-'}</td>
                    <td>${result.backtest ? result.backtest.max_loss.toFixed(1) + '%' : '-'}</td>
                    <td>${result.backtest ? result.backtest.total_trades : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showChart('${result.symbol}')">チャート</button>
                        <button class="btn btn-sm btn-success" onclick="addToPortfolio('${result.symbol}')">追加</button>
                                </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showChart(symbol) {
            // チャートデータの取得
            fetch('/get_stock_list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                    ticker: symbol,
                    period: 180  // 6ヶ月分のデータを取得
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                return;
            }

                // チャートの作成
                const chartData = data.stock_data.map(item => ({
                    date: new Date(item.date),
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close,
                    volume: item.volume
                }));

                // チャートの描画
                const chart = new ApexCharts(document.querySelector("#stockChart"), {
                    series: [{
                        name: '株価',
                            data: chartData.map(item => ({
                                x: item.date, 
                            y: [item.open, item.high, item.low, item.close]
                        }))
                    }],
                    chart: {
                        type: 'candlestick',
                        height: 400,
                        toolbar: {
                            show: true
                        }
                    },
                    title: {
                        text: `${data.stock_name} の株価チャート`,
                        align: 'left'
                    },
                    xaxis: {
                        type: 'datetime'
                    },
                    yaxis: {
                                tooltip: {
                            enabled: true
                        }
                    }
                });

                // 既存のチャートを削除
                const existingChart = document.querySelector("#stockChart");
                existingChart.innerHTML = '';

                // 新しいチャートを描画
                chart.render();

                // モーダルを表示
                $('#chartModal').modal('show');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('チャートデータの取得に失敗しました');
            });
        }

        // 持ち株リストの読み込み
        function loadPortfolio() {
            fetch('/get_portfolio')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.portfolio_list.length > 0) {
                        updatePortfolio(data.portfolio_list);
                        $('#portfolioSection').show();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // 持ち株リストの更新
        function updatePortfolio(purchaseList) {
            const tbody = $('#portfolioTable');
            tbody.empty();
            
            let totalInvestment = 0;
            let totalValue = 0;
            let totalProfit = 0;
            let totalProfitRate = 0;
            
            purchaseList.forEach(function(item) {
                const currentValue = Math.floor(item.current_value);
                const profitAmount = Math.floor(item.profit_amount);
                const profitRate = item.profit_rate;
                
                totalInvestment += item.total_amount;
                totalValue += currentValue;
                totalProfit += profitAmount;
                totalProfitRate += profitRate;
                
                const row = `
                    <tr>
                        <td>${item.symbol}</td>
                        <td>${item.name}</td>
                        <td>${Math.floor(item.current_price).toLocaleString()}円</td>
                        <td>${item.shares}株</td>
                        <td>${Math.floor(item.total_amount).toLocaleString()}円</td>
                        <td>${currentValue.toLocaleString()}円</td>
                        <td class="${profitRate >= 0 ? 'text-success' : 'text-danger'}">${profitRate.toFixed(2)}%</td>
                        <td class="${profitAmount >= 0 ? 'text-success' : 'text-danger'}">${profitAmount.toLocaleString()}円</td>
                        <td>${item.expected_value.toFixed(1)}%</td>
                        <td>${item.win_rate.toFixed(1)}%</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showChart('${item.symbol}')">チャート</button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
            
            // 合計情報の更新
            const avgProfitRate = totalProfitRate / purchaseList.length;
            const avgProfitAmount = Math.floor(totalProfit / purchaseList.length);
            const totalProfitRateValue = (totalProfit / totalInvestment) * 100;
            
            $('#totalInvestment').text(Math.floor(totalInvestment).toLocaleString());
            $('#totalValue').text(Math.floor(totalValue).toLocaleString());
            $('#totalProfit').text(Math.floor(totalProfit).toLocaleString());
            $('#totalProfitRate').text(totalProfitRateValue.toFixed(2));
            $('#avgProfitRate').text(avgProfitRate.toFixed(2));
            $('#avgProfitAmount').text(avgProfitAmount.toLocaleString());
            
            // 損益に応じて色を変更
            $('#totalProfit, #avgProfitAmount').removeClass('text-success text-danger')
                .addClass(totalProfit >= 0 ? 'text-success' : 'text-danger');
            $('#totalProfitRate, #avgProfitRate').removeClass('text-success text-danger')
                .addClass(totalProfitRateValue >= 0 ? 'text-success' : 'text-danger');

            // データベースに保存
            fetch('/update_portfolio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    portfolio_list: purchaseList
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Error:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // 自動購入機能
        $('#autoPurchaseBtn').click(function() {
            if (currentResults.length === 0) {
                alert('先に分析を実行してください。');
                return;
            }

            if (!confirm('期待値30以上で勝率80%以上の銘柄を100株ずつ自動購入します。よろしいですか？')) {
                return;
            }
            
            // 条件に合う銘柄をフィルタリング
            const purchaseList = currentResults
                .filter(result => result.expected_value >= 30 && result.backtest && result.backtest.win_rate >= 80)
                .map(result => ({
                    symbol: result.symbol,
                    name: result.name,
                    current_price: Math.floor(result.current_price),
                    shares: 100,  // 固定で100株
                    total_amount: Math.floor(result.current_price * 100),
                    expected_value: result.expected_value,
                    win_rate: result.backtest.win_rate,
                    profit_rate: 0,
                    profit_amount: 0
                }));

            if (purchaseList.length === 0) {
                alert('条件に合う銘柄が見つかりませんでした。');
                return;
            }

            // 持ち株リストを更新
            updatePortfolio(purchaseList);
            $('#portfolioSection').show();
        });
    </script>
</body>
</html> 